<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Clientes - JR Digital</title>
    <meta name="theme-color" content="#031026">
    <link rel="manifest" href="../manifest.webmanifest">
    <link rel="apple-touch-icon" href="../assets/img/pwa/icon-180.png">
    <link rel="icon" href="../assets/img/pwa/icon-192.png">
    <script defer src="../assets/js/pwa.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #F3F4F6;
            color: #1F2937;
        }

        .admin-layout {
            min-height: 100vh;
        }

        .sidebar {
            width: 270px;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            background: linear-gradient(180deg, #031026 0%, #062B63 30%, #0B7C61 74%, #043523 100%);
            color: #fff;
            padding: 24px 0;
            box-shadow: 4px 0 24px rgba(2, 6, 23, 0.24);
            overflow-y: auto;
            z-index: 30;
        }

        .sidebar-header {
            padding: 0 20px 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.14);
            margin-bottom: 12px;
            text-align: center;
        }

        .sidebar-logo {
            margin-bottom: 10px;
        }

        .sidebar-logo img {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            object-fit: contain;
        }

        .sidebar h2 {
            font-size: 1.06rem;
            font-weight: 900;
            letter-spacing: -0.3px;
        }

        .sidebar-nav {
            list-style: none;
            padding: 8px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 3px 0;
            padding: 11px 14px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            border-radius: 10px;
            border-left: 3px solid transparent;
            font-weight: 700;
            transition: .2s ease;
        }

        .sidebar-nav a:hover {
            background: rgba(255, 255, 255, 0.10);
            transform: translateX(2px);
        }

        .sidebar-nav a.active {
            background: rgba(30, 201, 255, 0.14);
            border-left-color: rgba(30, 201, 255, 0.95);
        }

        .sidebar-footer {
            padding: 14px 16px 0 16px;
            margin-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.14);
        }

        .logout-btn {
            width: 100%;
            border: 1.5px solid rgba(255, 255, 255, 0.35);
            background: rgba(255, 255, 255, 0.14);
            color: #fff;
            border-radius: 10px;
            padding: 10px;
            font-weight: 800;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #fff;
            color: #031026;
        }

        .main {
            margin-left: 270px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            position: sticky;
            top: 0;
            z-index: 20;
            background: linear-gradient(135deg, #031026 0%, #0A6CFF 45%, #0B7C61 100%);
            color: #fff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.18);
            padding: 12px 22px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .topbar h1 {
            font-size: 1.15rem;
            font-weight: 900;
            letter-spacing: -0.3px;
        }

        .topbar-user {
            font-size: .9rem;
            opacity: .95;
        }

        .menu-btn {
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.36);
            background: rgba(255, 255, 255, 0.12);
            color: #fff;
            border-radius: 8px;
            padding: 8px 10px;
            font-weight: 800;
            cursor: pointer;
        }

        .content {
            width: min(100%, 1800px);
            margin: 0 auto;
            padding: 24px;
        }

        .panel {
            background: #fff;
            border: 1px solid #E5E7EB;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
            padding: 20px;
        }

        .panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }

        .section-title {
            font-size: 1.35rem;
            font-weight: 900;
            color: #062B63;
        }

        .toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pill {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            background: #F3F4F6;
            border: 1px solid #E5E7EB;
            color: #334155;
            font-weight: 700;
        }

        .btn {
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: .88rem;
            font-weight: 800;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, #031026 0%, #0A6CFF 45%, #0B7C61 100%);
            color: #fff;
        }

        .btn-primary:hover { box-shadow: 0 10px 26px rgba(2, 6, 23, 0.28); }

        .btn-muted {
            background: #fff;
            color: #062B63;
            border: 1px solid #CBD5E1;
        }

        .btn-muted:hover { background: #F8FAFC; }

        .alert {
            background: #DBEAFE;
            border-left: 4px solid #3B82F6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            color: #1E40AF;
            font-size: .92rem;
            font-weight: 600;
        }

        .msg {
            margin: 12px 0;
            padding: 12px;
            border-radius: 10px;
            display: none;
            font-weight: 700;
        }

        .msg.ok {
            display: block;
            background: #ECFDF5;
            border: 1px solid #A7F3D0;
            color: #065F46;
        }

        .msg.err {
            display: block;
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #991B1B;
        }

        .table-wrap {
            border: 1px solid #E5E7EB;
            border-radius: 14px;
            overflow: auto;
            background: #fff;
        }

        table {
            width: 100%;
            min-width: 980px;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid #E5E7EB;
            text-align: left;
            font-size: 0.91rem;
            vertical-align: top;
        }

        th {
            background: #F8FAFC;
            color: #0F172A;
            font-weight: 900;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        td.actions {
            white-space: normal;
            text-align: right;
        }

        .hint {
            font-size: 0.79rem;
            color: #6B7280;
        }

        .pagination {
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .actions-dropdown {
            position: relative;
            display: inline-block;
        }

        .actions-trigger {
            background: #FFFFFF;
            color: #05422C;
            border: 1px solid #CDE3D8;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 0.84rem;
            font-weight: 800;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
            cursor: pointer;
        }

        .actions-trigger:hover {
            background: #F0F9F4;
            border-color: #99CCB5;
        }

        .actions-menu {
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            min-width: 220px;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.14);
            padding: 8px;
            display: none;
            z-index: 60;
        }

        .actions-menu.show { display: block; }

        .actions-menu-item {
            width: 100%;
            text-align: left;
            background: transparent;
            color: #0F172A;
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 0.84rem;
            font-weight: 700;
            cursor: pointer;
        }

        .actions-menu-item:hover {
            background: #F8FAFC;
            border-color: #E5E7EB;
        }

        .actions-menu-item.token { color: #05422C; }
        .actions-menu-item.danger { color: #991B1B; }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 80;
            padding: 14px;
        }

        .modal.show { display: flex; }

        .modal-card {
            width: min(760px, 100%);
            max-height: calc(100vh - 32px);
            overflow: auto;
            background: #fff;
            border: 1px solid #E5E7EB;
            border-radius: 16px;
            box-shadow: 0 24px 50px rgba(2, 6, 23, 0.32);
            padding: 18px;
        }

        .modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }

        .modal-head h3 {
            color: #062B63;
            font-size: 1.1rem;
            font-weight: 900;
        }

        .close-btn {
            border: 1px solid #CBD5E1;
            background: #fff;
            color: #334155;
            border-radius: 10px;
            padding: 7px 10px;
            font-weight: 800;
            cursor: pointer;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
        }

        .field.full {
            grid-column: 1 / -1;
        }

        .field label {
            font-size: 0.84rem;
            font-weight: 800;
            color: #334155;
        }

        .field input {
            padding: 10px 11px;
            border: 1px solid #D1D5DB;
            border-radius: 10px;
            outline: none;
            font-size: 0.92rem;
        }

        .field input:focus {
            border-color: #0A6CFF;
            box-shadow: 0 0 0 3px rgba(10, 108, 255, 0.15);
        }

        .drawer-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.45);
            z-index: 25;
        }

        @media (max-width: 1024px) {
            .content {
                padding: 16px;
                width: 100%;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .field.full {
                grid-column: auto;
            }
        }

        @media (max-width: 900px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform .25s ease;
            }

            body.drawer-open .sidebar {
                transform: translateX(0);
            }

            .drawer-overlay {
                display: block;
                opacity: 0;
                pointer-events: none;
                transition: opacity .2s ease;
            }

            body.drawer-open .drawer-overlay {
                opacity: 1;
                pointer-events: auto;
            }

            .main {
                margin-left: 0;
            }

            .menu-btn {
                display: inline-flex;
            }

            .topbar {
                padding: 10px 12px;
            }

            table thead { display: none; }

            table,
            tbody,
            tr,
            td {
                display: block;
                width: 100%;
                min-width: 0;
            }

            tr {
                border-bottom: 1px solid #E5E7EB;
                padding: 8px 0;
            }

            td {
                border-bottom: 1px dashed #E5E7EB;
                padding: 8px 4px;
                text-align: left !important;
            }

            td:last-child { border-bottom: none; }

            td::before {
                content: attr(data-label);
                display: block;
                font-size: 0.74rem;
                color: #6B7280;
                font-weight: 700;
                margin-bottom: 3px;
            }

            .actions-dropdown { width: 100%; }

            .actions-trigger {
                width: 100%;
                justify-content: space-between;
            }

            .actions-menu {
                left: 0;
                right: 0;
                min-width: 100%;
            }

            .pagination {
                flex-direction: column;
                align-items: stretch;
            }

            .pagination .btn {
                width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="../assets/css/jr-admin.css">
</head>
<body class="jr-admin">
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="../assets/img/logo/logoprincipal.png" alt="JR Digital" />
                </div>
                <h2>JR Digital</h2>
            </div>

            <ul class="sidebar-nav">
                <li><a href="admin-hub.html"><span>üè†</span> Panel Principal</a></li>
                <li><a class="active" href="customers.html"><span>üë•</span> Gestionar Clientes</a></li>
                <li><a href="licenses.html"><span>üìú</span> Gestionar Licencias</a></li>
                <li><a href="license-config.html"><span>üîê</span> Tokens Reset</a></li>
                <li><a href="products.html"><span>üß©</span> Productos</a></li>
                <li><a href="store-settings.html"><span>üè∑Ô∏è</span> Store Settings</a></li>
            </ul>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">Cerrar sesi√≥n</button>
            </div>
        </aside>

        <div class="drawer-overlay" onclick="closeDrawer()"></div>

        <main class="main">
            <header class="topbar">
                <button class="menu-btn" type="button" onclick="toggleDrawer()">‚ò∞ Men√∫</button>
                <h1>Gesti√≥n de Clientes</h1>
                <div class="topbar-user">Bienvenido, <strong id="userName">Admin</strong></div>
            </header>

            <section class="content">
                <div class="panel">
                    <div class="panel-head">
                        <h2 class="section-title">Clientes Registrados</h2>
                        <div class="toolbar">
                            <button class="btn btn-primary" type="button" onclick="openCreateModal()">+ Crear cliente</button>
                            <span class="pill" id="totalPill">Total: 0</span>
                            <button class="btn btn-muted" type="button" onclick="loadCustomers(1)">Refrescar</button>
                        </div>
                    </div>

                    <div class="alert">Gestiona clientes y usa el men√∫ Acciones para token reset, licencias y m√°s.</div>
                    <div id="msg" class="msg"></div>

                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Negocio</th>
                                    <th>Contacto</th>
                                    <th>Tel√©fono</th>
                                    <th>Email</th>
                                    <th>Business ID</th>
                                    <th>Creado</th>
                                    <th style="text-align:right;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="customersBody">
                                <tr><td colspan="7" style="color:#6B7280;">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination">
                        <button type="button" class="btn btn-muted" id="prevBtn" onclick="prevPage()">‚Üê Anterior</button>
                        <div style="color:#6B7280; font-weight:700; text-align:center;" id="pageInfo">P√°gina 1</div>
                        <button type="button" class="btn btn-muted" id="nextBtn" onclick="nextPage()">Siguiente ‚Üí</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal" id="createCustomerModal" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="createClientTitle">
            <div class="modal-head">
                <h3 id="createClientTitle">Crear cliente</h3>
                <button type="button" class="close-btn" onclick="closeCreateModal()">‚úï</button>
            </div>

            <form id="createForm">
                <div class="form-grid">
                    <div class="field full">
                        <label for="business_id">Business ID (opcional)</label>
                        <input id="business_id" name="business_id" placeholder="Ej: a1b2c3d4e5f6..." />
                        <div class="hint">Debe ser el mismo Business ID generado por el sistema del cliente.</div>
                    </div>

                    <div class="field full">
                        <label for="nombre_negocio">Nombre del negocio *</label>
                        <input id="nombre_negocio" name="nombre_negocio" placeholder="Ej: Colmado La Esquina" required />
                    </div>

                    <div class="field">
                        <label for="contacto_nombre">Nombre de contacto</label>
                        <input id="contacto_nombre" name="contacto_nombre" placeholder="Ej: Juan P√©rez" />
                    </div>

                    <div class="field">
                        <label for="contacto_telefono">Tel√©fono *</label>
                        <input id="contacto_telefono" name="contacto_telefono" placeholder="Ej: 8290000000" required />
                    </div>

                    <div class="field">
                        <label for="contacto_email">Email</label>
                        <input id="contacto_email" name="contacto_email" placeholder="Ej: cliente@correo.com" />
                    </div>

                    <div class="field">
                        <label for="rol_negocio">Rol del negocio</label>
                        <input id="rol_negocio" name="rol_negocio" placeholder="Ej: Ferreter√≠a, Colmado, Restaurante" />
                    </div>
                </div>

                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;">
                    <button type="button" class="btn btn-muted" onclick="resetForm()">Limpiar</button>
                    <button type="submit" class="btn btn-primary">Crear cliente</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = (() => {
            const host = (window.location && window.location.hostname) ? String(window.location.hostname) : '';
            const origin = (window.location && typeof window.location.origin === 'string') ? window.location.origin : '';
            if (host === 'localhost' || host === '127.0.0.1') return 'http://127.0.0.1:3000';
            if (origin && origin !== 'null') return origin;
            return '';
        })();

        let sessionId = localStorage.getItem('sessionId');
        let currentPage = 1;
        const limit = 20;

        window.addEventListener('load', () => {
            if (!sessionId) {
                window.location.href = '/admin/login.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const urlSessionId = urlParams.get('sessionId');
            if (urlSessionId) {
                sessionId = urlSessionId;
                localStorage.setItem('sessionId', sessionId);
            }

            verifySession();

            const form = document.getElementById('createForm');
            form.addEventListener('submit', createCustomer);

            const modal = document.getElementById('createCustomerModal');
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeCreateModal();
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeCreateModal();
                    closeAllActionsMenus();
                    closeDrawer();
                }
            });

            loadCustomers(1);
        });

        function toggleDrawer() {
            document.body.classList.toggle('drawer-open');
        }

        function closeDrawer() {
            document.body.classList.remove('drawer-open');
        }

        function openCreateModal() {
            document.getElementById('createCustomerModal').classList.add('show');
        }

        function closeCreateModal() {
            document.getElementById('createCustomerModal').classList.remove('show');
        }

        function showMessage(type, text) {
            const el = document.getElementById('msg');
            el.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
            el.textContent = text;
        }

        function clearMessage() {
            const el = document.getElementById('msg');
            el.className = 'msg';
            el.textContent = '';
        }

        async function apiFetch(path, options = {}) {
            const headers = Object.assign({}, options.headers || {}, {
                'x-session-id': sessionId
            });
            return fetch(`${API_URL}${path}`, Object.assign({}, options, { headers }));
        }

        async function verifySession() {
            try {
                const response = await fetch(`${API_URL}/api/verify-session`, {
                    cache: 'no-store',
                    headers: { 'x-session-id': sessionId }
                });
                const data = await response.json().catch(() => ({}));

                if (data.success) {
                    document.getElementById('userName').textContent = data.username || 'Admin';
                } else {
                    logout();
                }
            } catch (error) {
                console.warn('verifySession failed (transient):', error && error.message ? error.message : error);
            }
        }

        function resetForm() {
            document.getElementById('createForm').reset();
        }

        async function createCustomer(e) {
            e.preventDefault();
            clearMessage();

            const business_id = (document.getElementById('business_id').value || '').trim();
            const nombre_negocio = (document.getElementById('nombre_negocio').value || '').trim();
            const contacto_nombre = (document.getElementById('contacto_nombre').value || '').trim();
            const contacto_telefono = (document.getElementById('contacto_telefono').value || '').trim();
            const contacto_email = (document.getElementById('contacto_email').value || '').trim();
            const rol_negocio = (document.getElementById('rol_negocio').value || '').trim();

            if (!nombre_negocio) {
                showMessage('err', 'nombre_negocio es requerido');
                return;
            }

            if (!contacto_telefono) {
                showMessage('err', 'contacto_telefono es requerido');
                return;
            }

            try {
                const res = await apiFetch('/api/admin/customers', {
                    method: 'POST',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({
                        business_id: business_id || null,
                        nombre_negocio,
                        contacto_nombre: contacto_nombre || null,
                        contacto_telefono,
                        contacto_email: contacto_email || null,
                        rol_negocio: rol_negocio || null
                    })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.ok) {
                    showMessage('err', data?.message || `Error creando cliente (${res.status})`);
                    return;
                }

                showMessage('ok', '‚úÖ Cliente creado correctamente');
                document.getElementById('createForm').reset();
                closeCreateModal();
                await loadCustomers(1);
            } catch (err) {
                showMessage('err', 'No se pudo conectar con el servidor');
            }
        }

        function formatDate(value) {
            if (!value) return '';
            try {
                const d = new Date(value);
                return d.toLocaleString();
            } catch {
                return String(value);
            }
        }

        async function loadCustomers(page) {
            currentPage = Math.max(1, Number(page || 1) || 1);
            const body = document.getElementById('customersBody');
            body.innerHTML = '<tr><td colspan="7" style="color:#6B7280;">Cargando...</td></tr>';

            try {
                const res = await apiFetch(`/api/admin/customers?page=${encodeURIComponent(currentPage)}&limit=${encodeURIComponent(limit)}`);
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.ok) {
                    body.innerHTML = `<tr><td colspan="7" style="color:#991B1B;">${data?.message || 'Error cargando clientes'}</td></tr>`;
                    return;
                }

                const customers = data.customers || [];
                const total = Number(data.total || 0);
                document.getElementById('totalPill').textContent = `Total: ${total}`;
                document.getElementById('pageInfo').textContent = `P√°gina ${data.page || currentPage}`;

                const hasPrev = currentPage > 1;
                const hasNext = (currentPage * limit) < total;
                document.getElementById('prevBtn').disabled = !hasPrev;
                document.getElementById('nextBtn').disabled = !hasNext;

                if (!customers.length) {
                    body.innerHTML = '<tr><td colspan="7" style="color:#6B7280;">No hay clientes a√∫n.</td></tr>';
                    return;
                }

                body.innerHTML = customers.map(c => {
                    const negocio = c.nombre_negocio || '';
                    const contacto = c.contacto_nombre || '';
                    const tel = c.contacto_telefono || '';
                    const email = c.contacto_email || '';
                    const created = formatDate(c.created_at);
                    const customerId = c.id || '';
                    const businessId = c.business_id || '';
                    const menuId = `actions_menu_${String(customerId).replace(/[^a-zA-Z0-9_-]/g, '_')}`;
                    return `
                        <tr>
                            <td data-label="Negocio"><strong>${escapeHtml(negocio)}</strong><div class="hint">${escapeHtml(c.rol_negocio || '')}</div></td>
                            <td data-label="Contacto">${escapeHtml(contacto)}</td>
                            <td data-label="Tel√©fono">${escapeHtml(tel)}</td>
                            <td data-label="Email">${escapeHtml(email)}</td>
                            <td data-label="Business ID" style="font-family:monospace; font-weight:700;">${businessId ? escapeHtml(businessId) : '<span style="color:#6B7280;">‚Äî</span>'}</td>
                            <td data-label="Creado">${escapeHtml(created)}</td>
                            <td data-label="Acciones" class="actions">
                                <div class="actions-dropdown">
                                    <button class="actions-trigger" type="button" onclick="toggleActionsMenu(event, '${escapeAttr(menuId)}')">Acciones <span>‚ñæ</span></button>
                                    <div class="actions-menu" id="${escapeAttr(menuId)}">
                                        <button class="actions-menu-item token" type="button" onclick="goToSupportToken('${escapeAttr(businessId)}')">Generar token reset</button>
                                        <button class="actions-menu-item" type="button" onclick="setBusinessIdPrompt('${escapeAttr(customerId)}','${escapeAttr(negocio)}','${escapeAttr(businessId)}')">Asignar Business ID</button>
                                        <button class="actions-menu-item" type="button" onclick="goToLicenses('${escapeAttr(customerId)}')">Crear licencia</button>
                                        <button class="actions-menu-item danger" type="button" onclick="deleteCustomer('${escapeAttr(customerId)}','${escapeAttr(negocio)}')">Eliminar cliente</button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                body.innerHTML = '<tr><td colspan="7" style="color:#991B1B;">No se pudo conectar con el servidor.</td></tr>';
            }
        }

        async function setBusinessIdPrompt(customerId, negocio, currentBusinessId) {
            closeAllActionsMenus();
            const id = String(customerId || '').trim();
            if (!id) return;

            const current = String(currentBusinessId || '').trim();
            const name = String(negocio || '').trim();

            const next = prompt(
                `Asignar Business ID al cliente${name ? ' "' + name + '"' : ''}.\n\n` +
                (current ? `Actual: ${current}\n\n` : '') +
                'Pega aqu√≠ el Business ID del cliente:',
                current || ''
            );

            if (next === null) return;
            const business_id = String(next || '').trim();
            if (!business_id) {
                showMessage('err', 'business_id es requerido');
                return;
            }

            const force = Boolean(current && current !== business_id);
            if (force) {
                const ok = confirm('Este cliente ya ten√≠a business_id distinto. ¬øReemplazarlo?');
                if (!ok) return;
            }

            try {
                const res = await apiFetch(`/api/admin/customers/${encodeURIComponent(id)}/business_id`, {
                    method: 'PUT',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({ business_id, force })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.ok) {
                    showMessage('err', data?.message || `Error asignando business_id (${res.status})`);
                    return;
                }

                showMessage('ok', '‚úÖ Business ID actualizado');
                await loadCustomers(currentPage);
            } catch (e) {
                showMessage('err', 'No se pudo conectar con el servidor');
            }
        }

        async function deleteCustomer(customerId, negocio) {
            closeAllActionsMenus();
            const id = String(customerId || '').trim();
            if (!id) return;

            const name = String(negocio || '').trim();
            const msg = `¬øEliminar el cliente${name ? ' "' + name + '"' : ''}?\n\nEsto eliminar√° tambi√©n sus licencias y activaciones.`;
            const ok = window.confirm(msg);
            if (!ok) return;

            clearMessage();

            try {
                const res = await apiFetch(`/api/admin/customers/${encodeURIComponent(id)}`, {
                    method: 'DELETE'
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.ok) {
                    showMessage('err', data?.message || `Error eliminando cliente (${res.status})`);
                    return;
                }

                const count = Number(data.deletedLicensesCount || 0);
                showMessage('ok', `‚úÖ Cliente eliminado. Licencias eliminadas: ${count}`);
                await loadCustomers(currentPage);
            } catch (e) {
                showMessage('err', 'No se pudo conectar con el servidor');
            }
        }

        function prevPage() {
            if (currentPage <= 1) return;
            loadCustomers(currentPage - 1);
        }

        function nextPage() {
            loadCustomers(currentPage + 1);
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function escapeAttr(value) {
            return String(value || '').replace(/'/g, "\\'");
        }

        function closeAllActionsMenus(exceptId) {
            const openMenus = document.querySelectorAll('.actions-menu.show');
            openMenus.forEach((menu) => {
                if (!exceptId || menu.id !== exceptId) {
                    menu.classList.remove('show');
                }
            });
        }

        function toggleActionsMenu(event, menuId) {
            if (event) event.stopPropagation();
            const id = String(menuId || '').trim();
            if (!id) return;

            const menu = document.getElementById(id);
            if (!menu) return;

            const isOpen = menu.classList.contains('show');
            closeAllActionsMenus();
            if (!isOpen) menu.classList.add('show');
        }

        document.addEventListener('click', () => {
            closeAllActionsMenus();
        });

        function goToLicenses(customerId) {
            closeAllActionsMenus();
            const id = String(customerId || '').trim();
            if (!id) return;
            window.location.href = `/admin/licenses.html?customer_id=${encodeURIComponent(id)}`;
        }

        function goToSupportToken(businessId) {
            closeAllActionsMenus();
            const id = String(businessId || '').trim();
            if (!id) {
                showMessage('err', 'Este cliente no tiene business_id. As√≠gnalo primero.');
                return;
            }

            const target = `/admin/license-config.html?support_business_id=${encodeURIComponent(id)}&support_username=admin&autogen=1`;
            window.location.href = target;
        }

        async function logout() {
            try {
                await fetch(`${API_URL}/api/logout`, {
                    method: 'POST',
                    headers: {
                        'x-session-id': sessionId,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (e) {}

            localStorage.removeItem('sessionId');
            window.location.href = '/';
        }
    </script>
</body>
</html>
