<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuración de Plataforma - JR Digital</title>
  <meta name="theme-color" content="#05422C">
  <link rel="manifest" href="../manifest.webmanifest">
  <link rel="apple-touch-icon" href="../assets/img/pwa/icon-180.png">
  <link rel="icon" href="../assets/img/pwa/icon-192.png">
  <script defer src="../assets/js/pwa.js"></script>
  <link rel="stylesheet" href="../assets/css/jr-admin.css">
  <style>
    :root {
      --bg: #f3f4f6;
      --surface: #ffffff;
      --surface-soft: #f8fafc;
      --text: #1f2937;
      --muted: #6b7280;
      --brand: #05422c;
      --brand-2: #0d5a3b;
      --ok: #10b981;
      --err: #ef4444;
      --line: #e5e7eb;
      --shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .navbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
      color: #fff;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.16);
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .back-link {
      color: #fff;
      text-decoration: none;
      font-weight: 700;
      opacity: .95;
      white-space: nowrap;
    }

    .navbar h1 {
      margin: 0;
      font-size: 1.08rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: .92rem;
      white-space: nowrap;
    }

    .logout-btn {
      border: 1.5px solid rgba(255, 255, 255, 0.8);
      background: rgba(255, 255, 255, 0.16);
      color: #fff;
      border-radius: 9px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }

    .logout-btn:hover { background: #fff; color: var(--brand); }

    .page {
      width: min(1180px, calc(100% - 24px));
      margin: 20px auto 36px;
      display: grid;
      gap: 16px;
    }

    .hero {
      background: linear-gradient(135deg, rgba(5,66,44,.95), rgba(13,90,59,.92));
      border-radius: 18px;
      color: #fff;
      padding: 18px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 8px;
    }

    .hero h2 {
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: -.3px;
    }

    .hero p {
      margin: 0;
      opacity: .95;
      line-height: 1.45;
      font-size: .95rem;
    }

    .sessions-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }

    .session-card {
      grid-column: span 12;
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--line);
      box-shadow: 0 2px 12px rgba(15, 23, 42, 0.06);
      overflow: hidden;
    }

    .session-head {
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: var(--surface-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .session-title {
      margin: 0;
      font-size: 1.02rem;
      color: var(--brand);
      font-weight: 800;
    }

    .session-sub {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: .88rem;
    }

    .badge {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: .78rem;
      font-weight: 700;
      border: 1px solid var(--line);
      background: #fff;
      color: #334155;
      white-space: nowrap;
    }

    .badge.ok { color: #065f46; background: #d1fae5; border-color: #a7f3d0; }
    .badge.err { color: #7f1d1d; background: #fee2e2; border-color: #fecaca; }

    .session-body { padding: 16px; display: grid; gap: 14px; }

    .inline-note {
      background: #eff6ff;
      color: #1e40af;
      border-left: 4px solid #3b82f6;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: .9rem;
      line-height: 1.45;
    }

    .fields-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .field { display: grid; gap: 6px; }

    .switch-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border: 1.8px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      min-height: 44px;
    }

    .switch-label {
      font-size: .9rem;
      font-weight: 700;
      color: #334155;
    }

    .switch-wrap {
      position: relative;
      width: 52px;
      height: 30px;
      flex: 0 0 auto;
    }

    .switch-wrap input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .switch-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #cbd5e1;
      transition: .2s;
      border-radius: 999px;
    }

    .switch-slider::before {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      left: 3px;
      top: 3px;
      background: #fff;
      border-radius: 50%;
      transition: .2s;
      box-shadow: 0 1px 3px rgba(0,0,0,.2);
    }

    .switch-wrap input:checked + .switch-slider {
      background: var(--ok);
    }

    .switch-wrap input:checked + .switch-slider::before {
      transform: translateX(22px);
    }

    .switch-state {
      font-size: .82rem;
      font-weight: 800;
      color: #334155;
      min-width: 34px;
      text-align: right;
    }

    label {
      font-size: .87rem;
      font-weight: 700;
      color: #334155;
    }

    input[type="number"],
    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      border: 1.8px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: .93rem;
      color: var(--text);
      background: #fff;
      font-family: inherit;
    }

    textarea { min-height: 84px; resize: vertical; }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.14);
    }

    input:disabled {
      background: #f8fafc;
      color: #64748b;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 800;
      font-size: .9rem;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: #fff;
    }

    .btn-muted {
      background: #e5e7eb;
      color: #1f2937;
    }

    .btn-primary:disabled,
    .btn-muted:disabled { opacity: .65; cursor: not-allowed; }

    .message {
      display: none;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: .9rem;
      font-weight: 700;
    }

    .message.show { display: block; }
    .message.success { background: #d1fae5; color: #065f46; border: 1px solid #86efac; }
    .message.error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .status-item {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 10px;
      display: grid;
      gap: 4px;
      min-height: 88px;
    }

    .status-k {
      color: #64748b;
      font-size: .8rem;
      font-weight: 700;
    }

    .status-v {
      color: #0f172a;
      font-size: .92rem;
      font-weight: 800;
      word-break: break-word;
    }

    .loading {
      color: #64748b;
      font-weight: 600;
      font-size: .9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2.5px solid #e2e8f0;
      border-top-color: #10b981;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 1024px) {
      .status-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 760px) {
      .navbar {
        padding: 12px;
        flex-direction: column;
        align-items: stretch;
      }

      .navbar-left,
      .navbar-right { justify-content: space-between; }

      .page {
        width: calc(100% - 14px);
        margin-top: 12px;
        gap: 12px;
      }

      .hero {
        border-radius: 14px;
        padding: 14px;
      }

      .fields-2 { grid-template-columns: 1fr; }

      .actions { flex-direction: column-reverse; }

      .actions button {
        width: 100%;
        padding: 12px;
      }

      .status-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body class="jr-admin">
  <header class="navbar">
    <div class="navbar-left">
      <a href="admin-hub.html" class="back-link">← Volver</a>
      <h1>Configuración Administrativa</h1>
    </div>
    <div class="navbar-right">
      <span>Bienvenido, <strong id="userName">Admin</strong></span>
      <button class="logout-btn" onclick="logout()">Cerrar sesión</button>
    </div>
  </header>

  <main class="page">
    <section class="hero">
      <h2>Panel de Configuración por Sesiones</h2>
      <p>
        Administra licencias por defecto y recuperación de contraseña con token manual de soporte.
        El diseño está optimizado para escritorio y móvil para gestionar cambios incluso desde tu teléfono.
      </p>
    </section>

    <section class="sessions-grid">
      <article class="session-card">
        <div class="session-head">
          <div>
            <h3 class="session-title">Sesión 1 · Licencias por defecto</h3>
            <p class="session-sub">Valores predeterminados usados al crear nuevas licencias.</p>
          </div>
          <span class="badge" id="licenseBadge">Cargando...</span>
        </div>
        <div class="session-body">
          <div id="licenseMessage" class="message"></div>
          <div id="licenseLoading" class="loading"><span class="spinner"></span> Cargando configuración de licencias...</div>

          <form id="licenseForm" style="display:none;">
            <div class="inline-note">
              Los cambios aplican solo a licencias nuevas. Las ya emitidas no cambian automáticamente.
            </div>

            <div class="fields-2">
              <div class="field">
                <label for="demo_dias_validez">Días DEMO</label>
                <input type="number" id="demo_dias_validez" min="1" max="999" required>
              </div>
              <div class="field">
                <label for="full_dias_validez">Días FULL / ANUAL</label>
                <input type="number" id="full_dias_validez" min="1" max="9999" required>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn-muted" onclick="resetLicenseForm()">Restaurar valores cargados</button>
              <button type="submit" class="btn-primary" id="licenseSubmitBtn">Guardar licencias</button>
            </div>
          </form>
        </div>
      </article>

      <article class="session-card">
        <div class="session-head">
          <div>
            <h3 class="session-title">Sesión 2 · Recuperación con token de soporte</h3>
            <p class="session-sub">Genera token manual temporal para resetear contraseña local del cliente.</p>
          </div>
          <span class="badge ok" id="supportBadge">Activo</span>
        </div>
        <div class="session-body">
          <div class="inline-note" style="margin-top:10px;">
            Valida al cliente por teléfono, genera token temporal y compártelo. El token es de un solo uso.
          </div>

          <div class="fields-2">
            <div class="field">
              <label for="support_business_id">Business ID del cliente</label>
              <input type="text" id="support_business_id" placeholder="Ej: FT-123456">
            </div>
            <div class="field">
              <label for="support_username">Usuario local a resetear</label>
              <input type="text" id="support_username" value="admin" placeholder="admin">
            </div>
          </div>

          <div class="actions">
            <button type="button" class="btn-primary" id="supportGenerateBtn" onclick="generateSupportToken()">Generar token 15 min</button>
          </div>

          <div class="field">
            <label for="support_generated_token">Token generado</label>
            <input type="text" id="support_generated_token" readonly placeholder="Aún no generado">
          </div>

          <div class="actions">
            <button type="button" class="btn-muted" id="supportCopyBtn" onclick="copySupportToken()" disabled>Copiar token</button>
          </div>

          <div id="supportTokenMessage" class="message"></div>
        </div>
      </article>

      <article class="session-card">
        <div class="session-head">
          <div>
            <h3 class="session-title">Sesión 3 · Estado actual</h3>
            <p class="session-sub">Resumen rápido de licencias y modo de recuperación activo.</p>
          </div>
          <span class="badge ok">Panel en línea</span>
        </div>
        <div class="session-body">
          <div class="status-grid">
            <div class="status-item">
              <span class="status-k">DEMO (días)</span>
              <span class="status-v" id="statusDemoDays">-</span>
            </div>
            <div class="status-item">
              <span class="status-k">FULL (días)</span>
              <span class="status-v" id="statusFullDays">-</span>
            </div>
            <div class="status-item">
              <span class="status-k">Recuperación</span>
              <span class="status-v" id="statusRecoveryMode">Token soporte</span>
            </div>
            <div class="status-item">
              <span class="status-k">Validez token</span>
              <span class="status-v" id="statusTokenTtl">15 min</span>
            </div>
          </div>
        </div>
      </article>
    </section>
  </main>

  <script>
    const API_URL = (() => {
      const host = (window.location && window.location.hostname) ? String(window.location.hostname) : '';
      const origin = (window.location && typeof window.location.origin === 'string') ? window.location.origin : '';
      if (host === 'localhost' || host === '127.0.0.1') return 'http://127.0.0.1:3000';
      if (origin && origin !== 'null') return origin;
      return '';
    })();

    let sessionId = localStorage.getItem('sessionId');
    let originalLicenseConfig = {};

    window.addEventListener('load', () => {
      if (!sessionId) {
        window.location.href = '/admin/login.html';
        return;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const urlSessionId = urlParams.get('sessionId');
      if (urlSessionId) {
        sessionId = urlSessionId;
        localStorage.setItem('sessionId', sessionId);
      }

      verifySession();
      loadLicenseConfiguration();
    });

    function showMessage(elId, message, type) {
      const el = document.getElementById(elId);
      el.textContent = message;
      el.className = `message show ${type}`;
    }

    function setBadge(badgeId, text, type) {
      const el = document.getElementById(badgeId);
      el.textContent = text;
      el.className = `badge ${type || ''}`.trim();
    }

    function refreshStatusPanel() {
      document.getElementById('statusDemoDays').textContent = originalLicenseConfig.demo_dias_validez || '-';
      document.getElementById('statusFullDays').textContent = originalLicenseConfig.full_dias_validez || '-';
    }

    async function loadLicenseConfiguration() {
      const loading = document.getElementById('licenseLoading');
      const form = document.getElementById('licenseForm');

      loading.style.display = 'flex';
      form.style.display = 'none';

      try {
        const response = await fetch(`${API_URL}/api/admin/license-config`, {
          method: 'GET',
          cache: 'no-store',
          headers: { 'x-session-id': sessionId }
        });

        const data = await response.json();
        loading.style.display = 'none';

        if (response.ok && data.ok && data.config) {
          originalLicenseConfig = { ...data.config };
          document.getElementById('demo_dias_validez').value = data.config.demo_dias_validez;
          document.getElementById('full_dias_validez').value = data.config.full_dias_validez;

          form.style.display = 'block';
          setBadge('licenseBadge', 'Cargado', 'ok');
          refreshStatusPanel();
          return;
        }

        setBadge('licenseBadge', 'Error', 'err');
        showMessage('licenseMessage', data.message || 'No se pudo cargar la configuración de licencias', 'error');
      } catch (error) {
        loading.style.display = 'none';
        form.style.display = 'block';
        setBadge('licenseBadge', 'Error conexión', 'err');
        showMessage('licenseMessage', 'Error de conexión: ' + error.message, 'error');
      }
    }

    document.getElementById('licenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('licenseSubmitBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner" style="display:inline-block; margin-right:8px;"></span> Guardando...';

      try {
        const payload = {
          demo_dias_validez: parseInt(document.getElementById('demo_dias_validez').value, 10),
          demo_max_dispositivos: 1,
          full_dias_validez: parseInt(document.getElementById('full_dias_validez').value, 10),
          full_max_dispositivos: 1
        };

        const response = await fetch(`${API_URL}/api/admin/license-config`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'x-session-id': sessionId
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        if (response.ok && data.ok && data.config) {
          originalLicenseConfig = { ...data.config };
          refreshStatusPanel();
          setBadge('licenseBadge', 'Guardado', 'ok');
          showMessage('licenseMessage', 'Configuración de licencias guardada correctamente.', 'success');
          return;
        }

        setBadge('licenseBadge', 'Error', 'err');
        showMessage('licenseMessage', data.message || 'No se pudo guardar la configuración de licencias', 'error');
      } catch (error) {
        setBadge('licenseBadge', 'Error conexión', 'err');
        showMessage('licenseMessage', 'Error de conexión: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Guardar licencias';
      }
    });

    function resetLicenseForm() {
      document.getElementById('demo_dias_validez').value = originalLicenseConfig.demo_dias_validez || 15;
      document.getElementById('full_dias_validez').value = originalLicenseConfig.full_dias_validez || 365;
      document.getElementById('licenseMessage').classList.remove('show');
    }

    function clearSupportMessage() {
      document.getElementById('supportTokenMessage').classList.remove('show');
    }

    async function generateSupportToken() {
      const btn = document.getElementById('supportGenerateBtn');
      const businessId = document.getElementById('support_business_id').value.trim();
      const username = document.getElementById('support_username').value.trim() || 'admin';

      if (!businessId) {
        showMessage('supportTokenMessage', 'Ingresa el business_id del cliente.', 'error');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner" style="display:inline-block; margin-right:8px;"></span> Generando...';

      try {
        const response = await fetch(`${API_URL}/api/admin/support-reset/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-session-id': sessionId
          },
          body: JSON.stringify({
            business_id: businessId,
            username
          })
        });

        const data = await response.json().catch(() => ({}));
        if (response.ok && data.ok && data.token) {
          document.getElementById('support_generated_token').value = data.token;
          document.getElementById('supportCopyBtn').disabled = false;
          showMessage(
            'supportTokenMessage',
            `Token generado. Vence en ${data.ttl_minutes || 15} minutos.`,
            'success'
          );
          return;
        }

        showMessage('supportTokenMessage', data.message || 'No se pudo generar el token.', 'error');
      } catch (error) {
        showMessage('supportTokenMessage', 'Error de conexión: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Generar token 15 min';
      }
    }

    async function copySupportToken() {
      const token = document.getElementById('support_generated_token').value.trim();
      if (!token) {
        showMessage('supportTokenMessage', 'No hay token para copiar.', 'error');
        return;
      }

      try {
        await navigator.clipboard.writeText(token);
        showMessage('supportTokenMessage', 'Token copiado al portapapeles.', 'success');
      } catch (_) {
        showMessage('supportTokenMessage', 'No se pudo copiar automáticamente. Cópialo manualmente.', 'error');
      }
    }

    document.getElementById('support_business_id').addEventListener('input', clearSupportMessage);
    document.getElementById('support_username').addEventListener('input', clearSupportMessage);

    async function verifySession() {
      try {
        const response = await fetch(`${API_URL}/api/verify-session`, {
          method: 'GET',
          cache: 'no-store',
          headers: { 'x-session-id': sessionId }
        });
        const data = await response.json().catch(() => ({}));

        if (data.success) {
          document.getElementById('userName').textContent = data.username || 'Admin';
        } else {
          logout();
        }
      } catch (_) {
        logout();
      }
    }

    async function logout() {
      try {
        await fetch(`${API_URL}/api/logout`, {
          method: 'POST',
          headers: {
            'x-session-id': sessionId,
            'Content-Type': 'application/json'
          }
        });
      } catch (_) {}

      localStorage.removeItem('sessionId');
      window.location.href = '/';
    }
  </script>
</body>
</html>
