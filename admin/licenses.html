<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#031026">
    <link rel="manifest" href="../manifest.webmanifest">
    <link rel="apple-touch-icon" href="../assets/img/pwa/icon-180.png">
    <link rel="icon" href="../assets/img/pwa/icon-192.png">
    <script defer src="../assets/js/pwa.js"></script>
    <title>Gestionar Licencias - JR Digital</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #F3F4F6;
            color: #1F2937;
        }

        .navbar {
            background: linear-gradient(135deg, #05422C 0%, #0d5a3b 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .navbar h1 {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .navbar-user p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: white;
            color: #05422C;
        }

        .back-link {
            color: white;
            text-decoration: none;
            margin-right: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            opacity: 0.8;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            animation: slideInUp 0.6s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #05422C;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .section-subtitle {
            font-size: 0.95rem;
            color: #6B7280;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        label {
            font-size: 0.95rem;
            font-weight: 700;
            color: #05422C;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            padding: 12px 14px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            background-color: #F9FAFB;
            color: #1F2937;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #10B981;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        button {
            background: linear-gradient(135deg, #05422C 0%, #0d5a3b 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            box-shadow: 0 8px 20px rgba(5, 66, 44, 0.3);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
            animation: slideInDown 0.3s ease;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background-color: #D1FAE5;
            color: #065F46;
            border-left: 4px solid #10B981;
        }

        .message.error {
            background-color: #FEE2E2;
            color: #991B1B;
            border-left: 4px solid #EF4444;
        }

        .alert {
            background-color: #DBEAFE;
            border-left: 4px solid #3B82F6;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #1E40AF;
            font-size: 0.9rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .auto-fill-hint {
            font-size: 0.85rem;
            color: #10B981;
            font-weight: 600;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .navbar-user {
                flex-direction: column;
                gap: 10px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }
        }
    </style>
    <link rel="stylesheet" href="../assets/css/jr-admin.css">
</head>
<body class="jr-admin">
    <!-- NAVBAR -->
    <div class="navbar">
        <div style="display: flex; align-items: center; gap: 20px;">
            <a href="admin-hub.html" class="back-link">‚Üê Volver</a>
            <h1>
                <span class="jr-admin-brand">
                    <img src="../assets/img/logo/logoprincipal.png" alt="JR Digital" class="jr-admin-brandLogo" />
                    <span class="jr-admin-brandText">
                        <span class="jr-admin-brandName">JR Digital</span>
                        <span class="jr-admin-brandPage">Gestionar Licencias</span>
                    </span>
                </span>
            </h1>
        </div>
        <div class="navbar-user">
            <p>Bienvenido, <strong id="userName">Admin</strong></p>
            <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div class="container">
        <!-- SECCI√ìN: Crear Nueva Licencia -->
        <div class="section">
            <h2 class="section-title">‚ûï Crear Nueva Licencia</h2>
            <p class="section-subtitle">
                Completa el formulario para crear una nueva licencia. Los d√≠as y dispositivos se rellenar√°n autom√°ticamente 
                seg√∫n la configuraci√≥n del tipo de licencia que selecciones, pero puedes modificarlos si lo necesitas.
            </p>

            <div id="message" class="message"></div>

            <div class="alert">
                üí° <strong>Sugerencia:</strong> Primero aseg√∫rate de que la configuraci√≥n de licencias sea correcta. 
                Luego el formulario rellenar√° autom√°ticamente los valores al seleccionar el tipo.
                <a href="license-config.html" style="color: #1E40AF; text-decoration: underline;">Ir a Configuraci√≥n ‚Üí</a>
            </div>

            <form id="createLicenseForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="project_code">Proyecto *</label>
                        <select id="project_code" name="project_code" required>
                            <option value="">-- Selecciona un proyecto --</option>
                        </select>
                        <div class="auto-fill-hint">Las licencias se crean por proyecto (ej: <b>FULLPOS</b>). Si no aparece, puedes crearlo aqu√≠ mismo.</div>
                    </div>

                    <div class="form-group">
                        <label style="display:flex; align-items:center; gap:10px; font-weight:700; margin-top: 28px;">
                            <input type="checkbox" id="autoActivate" checked>
                            Activar autom√°ticamente (inicia la prueba hoy)
                        </label>
                        <div class="auto-fill-hint">Recomendado para DEMO: pone estado <b>ACTIVA</b> y calcula fechas.</div>
                    </div>
                </div>

                <div class="form-row" style="margin-top:-6px;">
                    <div class="form-group">
                        <label for="newProjectCode">Crear proyecto (opcional)</label>
                        <input type="text" id="newProjectCode" placeholder="Code (ej: FULLPOS)" />
                        <div class="auto-fill-hint">El <b>code</b> se usa para asignar licencias por proyecto.</div>
                    </div>
                    <div class="form-group">
                        <label for="newProjectName">&nbsp;</label>
                        <input type="text" id="newProjectName" placeholder="Nombre (ej: JR Digital)" />
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button type="button" onclick="createProjectFromUi()" style="background:#111827;">‚ûï Crear Proyecto</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="customer_id">Cliente *</label>
                    <select id="customer_id" name="customer_id" required>
                        <option value="">-- Selecciona un cliente --</option>
                    </select>
                    <div class="auto-fill-hint">Carga tus clientes primero en la secci√≥n de Gesti√≥n de Clientes</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="deliveryMode">Modo de uso *</label>
                        <select id="deliveryMode" name="delivery_mode" required>
                            <option value="ONLINE">üåê Online (requiere internet)</option>
                            <option value="OFFLINE">üíæ Offline (archivo local firmado)</option>
                        </select>
                        <div class="auto-fill-hint">Offline descarga un archivo <b>.lic.json</b> para validar sin internet.</div>
                    </div>

                    <div class="form-group" id="offlineDeviceWrap" style="display:none;">
                        <label for="offlineDeviceId">Device ID (opcional)</label>
                        <input type="text" id="offlineDeviceId" name="offline_device_id" placeholder="Ej: PC-CAJA-01">
                        <div class="auto-fill-hint">Si lo llenas, el archivo queda amarrado a ese equipo.</div>
                    </div>
                </div>

                <div class="form-group" id="offlineEnsureActiveWrap" style="display:none;">
                    <label style="display:flex; align-items:center; gap:10px; font-weight:700;">
                        <input type="checkbox" id="offlineEnsureActive" checked>
                        Activar licencia autom√°ticamente para exportar (recomendado)
                    </label>
                    <div class="auto-fill-hint">Si la licencia est√° PENDIENTE y no tiene fechas, el backend la inicia para poder firmar el archivo.</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="licenseType">Tipo de Licencia *</label>
                        <select id="licenseType" name="tipo" required>
                            <option value="">-- Selecciona un tipo --</option>
                            <option value="DEMO">üß™ DEMO (Prueba)</option>
                            <option value="FULL">‚≠ê FULL (Pago)</option>
                        </select>
                        <div class="auto-fill-hint">Al cambiar el tipo, los campos de abajo se llenar√°n autom√°ticamente</div>
                    </div>

                    <div class="form-group">
                        <label for="diasValidez">D√≠as de Validez *</label>
                        <input type="number" id="diasValidez" name="dias_validez" min="1" max="9999" required>
                        <div class="auto-fill-hint" id="diasHint"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="maxDispositivos">M√°ximo de Dispositivos *</label>
                        <input type="number" id="maxDispositivos" name="max_dispositivos" min="1" max="99" required>
                        <div class="auto-fill-hint" id="dispositivosHint"></div>
                    </div>

                    <div class="form-group">
                        <label for="notas">Notas (opcional)</label>
                        <textarea id="notas" name="notas" placeholder="Agreg√° notas si lo necesitas..."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="submit" id="submitBtn">‚úÖ Crear Licencia</button>
                    <button type="reset" style="background: #E5E7EB; color: #1F2937;">üîÑ Limpiar</button>
                </div>
            </form>
        </div>

        <!-- SECCI√ìN: Lista de Licencias -->
        <div class="section">
            <h2 class="section-title">üìã Listado de Licencias</h2>
            <p class="section-subtitle">
                Aqu√≠ aparecer√°n todas las licencias creadas. Podr√°s filtrar por cliente, tipo o estado.
            </p>

            <div class="form-row" style="margin-bottom: 16px;">
                <div class="form-group">
                    <label for="projectFilter">Filtrar por proyecto</label>
                    <select id="projectFilter">
                        <option value="ALL">Todos</option>
                    </select>
                    <div class="auto-fill-hint">Tip: si seleccionas un proyecto, la lista mostrar√° solo sus licencias.</div>
                </div>

                <div class="form-group">
                    <label style="opacity:0;">.</label>
                    <button type="button" onclick="loadLicenses()" style="width: fit-content;">üîé Aplicar filtro</button>
                </div>
            </div>

            <div id="licensesList">
                <div style="text-align: center; padding: 40px; color: #6B7280;">
                    <p>‚è≥ Cargando licencias...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/js/adminLicenseConfig.js"></script>
    <script>
        const API_URL = '';
        let sessionId = localStorage.getItem('sessionId');

        // Deep-link support: /admin/licenses.html?customer_id=...
        let deepLinkCustomerId = null;
        let deepLinkAppliedToList = false;

        window.addEventListener('load', () => {
            if (!sessionId) {
                window.location.href = '/admin/login.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            deepLinkCustomerId = urlParams.get('customer_id');
            const urlSessionId = urlParams.get('sessionId');
            if (urlSessionId) {
                sessionId = urlSessionId;
                localStorage.setItem('sessionId', sessionId);
            }

            verifySession();
            initializeForm();
            loadLicenses();
        });

        /**
         * Inicializar el formulario con auto-fill
         */
        async function initializeForm() {
            // Cargar la configuraci√≥n de licencias
            if (window.loadLicenseConfig) {
                await window.loadLicenseConfig();
            }

            // Cargar proyectos
            await loadProjects();

            // Cargar clientes
            await loadCustomers();

            // Si venimos desde Clientes, preseleccionar customer_id
            if (deepLinkCustomerId) {
                const select = document.getElementById('customer_id');
                if (select) {
                    const exists = Array.from(select.options || []).some(o => String(o.value) === String(deepLinkCustomerId));
                    if (exists) {
                        select.value = String(deepLinkCustomerId);
                    }
                }
            }

            // Configurar evento de cambio de tipo
            const tipoSelect = document.getElementById('licenseType');
            tipoSelect.addEventListener('change', (e) => {
                const tipo = e.target.value.toUpperCase();

                // Activaci√≥n autom√°tica: por defecto s√≠ para DEMO, no para FULL
                const autoActivate = document.getElementById('autoActivate');
                if (autoActivate) {
                    autoActivate.checked = (tipo === 'DEMO');
                }

                if (tipo === 'DEMO' || tipo === 'FULL') {
                    const defaults = window.getDefaultsForLicenseType ? 
                        window.getDefaultsForLicenseType(tipo) : null;
                    
                    if (defaults) {
                        document.getElementById('diasValidez').value = defaults.dias_validez;
                        document.getElementById('maxDispositivos').value = defaults.max_dispositivos;
                        
                        // Actualizar hints
                        document.getElementById('diasHint').textContent = 
                            `(Configuraci√≥n predeterminada: ${defaults.dias_validez} d√≠as)`;
                        document.getElementById('dispositivosHint').textContent = 
                            `(Configuraci√≥n predeterminada: ${defaults.max_dispositivos} dispositivos)`;
                    }
                }
            });

            // Configurar modo Online/Offline
            const deliveryMode = document.getElementById('deliveryMode');
            deliveryMode.addEventListener('change', () => {
                applyDeliveryModeUi();
            });
            applyDeliveryModeUi();
        }

        function applyDeliveryModeUi() {
            const mode = (document.getElementById('deliveryMode')?.value || 'ONLINE').toUpperCase();
            const isOffline = mode === 'OFFLINE';
            const deviceWrap = document.getElementById('offlineDeviceWrap');
            const ensureWrap = document.getElementById('offlineEnsureActiveWrap');
            if (deviceWrap) deviceWrap.style.display = isOffline ? 'block' : 'none';
            if (ensureWrap) ensureWrap.style.display = isOffline ? 'block' : 'none';
        }

        /**
         * Cargar lista de clientes
         */
        async function loadCustomers() {
            try {
                const response = await fetch(`${API_URL}/api/admin/customers?limit=100`, {
                    method: 'GET',
                    headers: {
                        'x-session-id': sessionId
                    }
                });

                const data = await response.json();

                if (data.ok && data.customers && data.customers.length > 0) {
                    const select = document.getElementById('customer_id');
                    data.customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = customer.nombre_negocio || `Cliente ${customer.id.substring(0, 8)}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        /**
         * Cargar lista de licencias
         */
        async function loadLicenses() {
            try {
                const filter = document.getElementById('projectFilter')?.value || 'ALL';
                const qs = new URLSearchParams();
                qs.set('limit', '100');
                if (filter && filter !== 'ALL') qs.set('project_code', filter);

                // Si venimos con deep-link customer_id, aplicarlo 1 vez al listado.
                if (deepLinkCustomerId && !deepLinkAppliedToList) {
                    qs.set('customer_id', String(deepLinkCustomerId));
                    deepLinkAppliedToList = true;
                }

                const response = await fetch(`${API_URL}/api/admin/licenses?${qs.toString()}`, {
                    method: 'GET',
                    headers: {
                        'x-session-id': sessionId
                    }
                });

                const data = await response.json();

                const container = document.getElementById('licensesList');

                if (data.ok && data.licenses && data.licenses.length > 0) {
                    let html = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #F3F4F6; border-bottom: 2px solid #E5E7EB;">
                                    <th style="padding: 12px; text-align: left; font-weight: 700;">Proyecto</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 700;">Cliente</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 700;">Clave</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 700;">Tipo</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 700;">D√≠as</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 700;">Dispositivos</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 700;">Estado</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 700;">V√°lida Hasta</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 700;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.licenses.forEach(license => {
                        const icon = license.tipo === 'DEMO' ? 'üß™' : '‚≠ê';
                        const statusColor = {
                            'PENDIENTE': '#FFA500',
                            'ACTIVA': '#10B981',
                            'VENCIDA': '#EF4444',
                            'BLOQUEADA': '#6B7280'
                        }[license.estado] || '#6B7280';

                        const fechaFin = license.fecha_fin ? 
                            new Date(license.fecha_fin).toLocaleDateString('es-ES') : 'N/A';

                        html += `
                            <tr style="border-bottom: 1px solid #E5E7EB;">
                                <td style="padding: 12px; font-weight: 900;">${(license.project_code || 'DEFAULT')}</td>
                                <td style="padding: 12px; font-weight: 600;">${license.nombre_negocio || '‚Äî'}</td>
                                <td style="padding: 12px;">${license.license_key}</td>
                                <td style="padding: 12px;">${icon} ${license.tipo}</td>
                                <td style="padding: 12px;">${license.dias_validez}</td>
                                <td style="padding: 12px;">${license.max_dispositivos}</td>
                                <td style="padding: 12px;">
                                    <span style="background: ${statusColor}20; color: ${statusColor}; 
                                    padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                                        ${license.estado}
                                    </span>
                                </td>
                                <td style="padding: 12px;">${fechaFin}</td>
                                <td style="padding: 12px;">
                                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                        <button onclick="openDetailModal('${license.id}')" style="padding:6px 10px; border:none; border-radius:6px; background:#3B82F6; color:#fff; cursor:pointer; font-weight:700; font-size:12px;">Ver</button>
                                        <button onclick="openEditModal('${license.id}')" style="padding:6px 10px; border:none; border-radius:6px; background:#10B981; color:#fff; cursor:pointer; font-weight:700; font-size:12px;">Editar</button>
                                        <button onclick="promptOfflineDownload('${license.id}')" style="padding:6px 10px; border:none; border-radius:6px; background:#111827; color:#fff; cursor:pointer; font-weight:900; font-size:12px;">üíæ Offline</button>
                                        <button onclick="deleteLicense('${license.id}')" style="padding:6px 10px; border:none; border-radius:6px; background:#6B7280; color:#fff; cursor:pointer; font-weight:900; font-size:12px;">Eliminar</button>
                                        ${license.estado === 'BLOQUEADA'
                                            ? `<button onclick="activarManual('${license.id}')" style="padding:6px 10px; border:none; border-radius:6px; background:#F59E0B; color:#fff; cursor:pointer; font-weight:700; font-size:12px;">Desbloquear</button>`
                                            : `<button onclick="bloquearLicense('${license.id}')" style="padding:6px 10px; border:none; border-radius:6px; background:#EF4444; color:#fff; cursor:pointer; font-weight:700; font-size:12px;">Bloquear</button>`
                                        }
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    html += `</tbody></table>`;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6B7280;">
                            <p>üì≠ No hay licencias creadas a√∫n.</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">Crea una nueva licencia usando el formulario arriba.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading licenses:', error);
                document.getElementById('licensesList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #991B1B;">
                        <p>‚ö†Ô∏è Error al cargar licencias: ${error.message}</p>
                    </div>
                `;
            }
        }

        /**
         * Manejar env√≠o del formulario
         */
        document.getElementById('createLicenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '‚è≥ Creando...';

            try {
                const deliveryMode = (document.getElementById('deliveryMode')?.value || 'ONLINE').toUpperCase();
                const isOffline = deliveryMode === 'OFFLINE';
                const offlineDeviceIdRaw = document.getElementById('offlineDeviceId')?.value;
                const offlineDeviceId = offlineDeviceIdRaw ? String(offlineDeviceIdRaw).trim() : '';
                const ensureActive = document.getElementById('offlineEnsureActive')?.checked !== false;

                const payload = {
                    project_code: document.getElementById('project_code').value,
                    customer_id: document.getElementById('customer_id').value,
                    tipo: document.getElementById('licenseType').value.toUpperCase(),
                    dias_validez: parseInt(document.getElementById('diasValidez').value),
                    max_dispositivos: parseInt(document.getElementById('maxDispositivos').value),
                    notas: document.getElementById('notas').value || null,
                    auto_activate: document.getElementById('autoActivate')?.checked !== false
                };

                const response = await fetch(`${API_URL}/api/admin/licenses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.ok) {
                    showMessage(isOffline ? '‚úÖ Licencia creada. Descargando archivo offline‚Ä¶' : '‚úÖ Licencia creada correctamente', 'success');
                    document.getElementById('createLicenseForm').reset();
                    applyDeliveryModeUi();

                    if (isOffline && data.license && data.license.id) {
                        // Descargar el archivo firmado (requiere headers, por eso usamos fetch+blob)
                        await downloadOfflineLicenseFile(data.license.id, {
                            deviceId: offlineDeviceId || null,
                            ensureActive
                        });
                    }
                    
                    // Recargar lista
                    setTimeout(() => {
                        loadLicenses();
                        document.getElementById('message').classList.remove('show');
                    }, 2000);
                } else {
                    showMessage('‚ùå ' + (data.message || 'Error al crear licencia'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '‚úÖ Crear Licencia';
            }
        });

        function parseFilenameFromContentDisposition(cd) {
            if (!cd) return null;
            // filename="..." o filename=...
            const match = /filename\*=UTF-8''([^;]+)|filename="([^"]+)"|filename=([^;]+)/i.exec(cd);
            const raw = match ? (match[1] || match[2] || match[3]) : null;
            if (!raw) return null;
            try {
                return decodeURIComponent(String(raw).trim());
            } catch {
                return String(raw).trim();
            }
        }

        async function downloadOfflineLicenseFile(licenseId, { deviceId = null, ensureActive = true } = {}) {
            const params = new URLSearchParams();
            params.set('download', '1');
            if (ensureActive) params.set('ensure_active', 'true');
            if (deviceId) params.set('device_id', String(deviceId).trim());

            const url = `${API_URL}/api/admin/licenses/${licenseId}/license-file?${params.toString()}`;

            let response;
            try {
                response = await fetch(url, {
                    method: 'GET',
                    headers: { 'x-session-id': sessionId }
                });
            } catch (e) {
                showMessage('‚ùå No se pudo descargar (red): ' + e.message, 'error');
                return;
            }

            if (!response.ok) {
                try {
                    const err = await response.json();
                    showMessage('‚ùå ' + (err.message || 'No se pudo generar la licencia offline'), 'error');
                } catch {
                    showMessage('‚ùå No se pudo generar la licencia offline', 'error');
                }
                return;
            }

            const blob = await response.blob();
            const filename = parseFilenameFromContentDisposition(response.headers.get('content-disposition')) || 'license.lic.json';

            const blobUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(blobUrl), 2500);
        }

        async function promptOfflineDownload(licenseId) {
            const raw = prompt('Device ID (opcional).\n\nDeja vac√≠o si no quieres amarrar a un equipo:', '');
            if (raw === null) return;
            const deviceId = String(raw).trim();
            await downloadOfflineLicenseFile(licenseId, {
                deviceId: deviceId || null,
                ensureActive: true
            });
        }

        /**
         * Mostrar mensaje
         */
        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = `message show ${type}`;
        }

        /**
         * Verificar sesi√≥n
         */
        async function verifySession() {
            try {
                const response = await fetch(`${API_URL}/api/verify-session?sessionId=${sessionId}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('userName').textContent = data.username;
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        /**
         * Cargar lista de proyectos
         */
        async function loadProjects() {
            const projectSelect = document.getElementById('project_code');
            const projectFilter = document.getElementById('projectFilter');

            // Reset UI
            if (projectSelect) projectSelect.innerHTML = '<option value="">-- Selecciona un proyecto --</option>';
            if (projectFilter) projectFilter.innerHTML = '<option value="ALL">Todos</option>';

            try {
                const response = await fetch(`${API_URL}/api/admin/projects`, {
                    method: 'GET',
                    headers: {
                        'x-session-id': sessionId
                    }
                });

                const data = await response.json();
                const projects = (data && data.ok && Array.isArray(data.projects)) ? data.projects : [];

                // Guardar selecci√≥n anterior
                const last = localStorage.getItem('selectedProjectCode') || '';

                for (const p of projects) {
                    const code = String(p.code || '').trim();
                    if (!code) continue;

                    if (projectSelect) {
                        const opt = document.createElement('option');
                        opt.value = code;
                        opt.textContent = `${code} ‚Äî ${p.name || code}`;
                        projectSelect.appendChild(opt);
                    }

                    if (projectFilter) {
                        const opt2 = document.createElement('option');
                        opt2.value = code;
                        opt2.textContent = `${code}`;
                        projectFilter.appendChild(opt2);
                    }
                }

                // Default: FULLPOS si existe, si no DEFAULT, si no el primero
                const codes = projects.map(p => String(p.code || '').trim()).filter(Boolean);
                const preferred = last || (codes.includes('FULLPOS') ? 'FULLPOS' : (codes.includes('DEFAULT') ? 'DEFAULT' : (codes[0] || '')));

                if (projectSelect && preferred) projectSelect.value = preferred;
                if (projectFilter && preferred) projectFilter.value = preferred;

                const remember = () => {
                    const v = projectSelect?.value || '';
                    if (v) localStorage.setItem('selectedProjectCode', v);
                };
                if (projectSelect) projectSelect.addEventListener('change', remember);
                if (projectFilter) projectFilter.addEventListener('change', () => {
                    // Si filtras por un proyecto, sincronizamos el selector de creaci√≥n
                    const v = projectFilter.value;
                    if (v && v !== 'ALL' && projectSelect) {
                        projectSelect.value = v;
                        localStorage.setItem('selectedProjectCode', v);
                    }
                });
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        async function createProjectFromUi() {
            const codeRaw = document.getElementById('newProjectCode')?.value || '';
            const nameRaw = document.getElementById('newProjectName')?.value || '';
            const code = String(codeRaw).trim().toUpperCase();
            const name = String(nameRaw).trim() || code;

            if (!code) {
                showMessage('‚ùå Debes escribir el code del proyecto (ej: FULLPOS)', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId
                    },
                    body: JSON.stringify({ code, name })
                });

                const data = await response.json();
                if (!response.ok || !data.ok) {
                    showMessage('‚ùå ' + (data.message || 'No se pudo crear el proyecto'), 'error');
                    return;
                }

                showMessage('‚úÖ Proyecto creado: ' + code, 'success');
                document.getElementById('newProjectCode').value = '';
                document.getElementById('newProjectName').value = '';
                localStorage.setItem('selectedProjectCode', code);
                await loadProjects();
            } catch (e) {
                showMessage('‚ùå Error creando proyecto: ' + e.message, 'error');
            }
        }

        /**
         * Cerrar sesi√≥n
         */
        async function logout() {
            try {
                await fetch(`${API_URL}/api/logout`, {
                    method: 'POST',
                    headers: {
                        'x-session-id': sessionId,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (e) {}

            localStorage.removeItem('sessionId');
            // Volver a la p√°gina principal (no al login)
            window.location.href = '/';
        }

        // ==============================
        // CONTROL TOTAL (DETALLE / EDICI√ìN / ACCIONES)
        // ==============================

        function ensureModals() {
            if (document.getElementById('licenseDetailModal')) return;

            const modalsHtml = `
                <div id="licenseDetailModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:#fff; width:min(900px, 100%); border-radius:12px; box-shadow: 0 20px 60px rgba(0,0,0,0.35); overflow:hidden;">
                        <div style="padding:18px 20px; background:#F9FAFB; border-bottom:1px solid #E5E7EB; display:flex; align-items:center; justify-content:space-between; gap:10px;">
                            <div>
                                <div style="font-weight:900; color:#05422C; font-size:1.1rem;">Detalles de Licencia</div>
                                <div id="detailSub" style="color:#6B7280; font-size:0.85rem;"></div>
                            </div>
                            <button onclick="closeDetailModal()" style="padding:8px 12px; border-radius:8px; border:1px solid #D1D5DB; background:#fff; cursor:pointer; font-weight:700;">Cerrar</button>
                        </div>
                        <div style="padding:20px;">
                            <div id="detailBody" style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;"></div>

                            <div style="margin-top:18px;">
                                <div style="font-weight:900; color:#05422C; margin-bottom:10px;">Activaciones</div>
                                <div id="activationsBox" style="border:1px solid #E5E7EB; border-radius:10px; overflow:hidden;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="licenseEditModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:#fff; width:min(600px, 100%); border-radius:12px; box-shadow: 0 20px 60px rgba(0,0,0,0.35); overflow:hidden;">
                        <div style="padding:18px 20px; background:#F9FAFB; border-bottom:1px solid #E5E7EB; display:flex; align-items:center; justify-content:space-between; gap:10px;">
                            <div style="font-weight:900; color:#05422C; font-size:1.1rem;">Editar Licencia</div>
                            <button onclick="closeEditModal()" style="padding:8px 12px; border-radius:8px; border:1px solid #D1D5DB; background:#fff; cursor:pointer; font-weight:700;">Cerrar</button>
                        </div>
                        <div style="padding:20px;">
                            <div style="display:grid; gap:14px;">
                                <div>
                                    <label style="display:block; margin-bottom:6px; font-weight:700;">Tipo</label>
                                    <select id="editTipo" style="width:100%; padding:10px; border:1px solid #D1D5DB; border-radius:8px;">
                                        <option value="DEMO">DEMO</option>
                                        <option value="FULL">FULL</option>
                                    </select>
                                </div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                                    <div>
                                        <label style="display:block; margin-bottom:6px; font-weight:700;">D√≠as validez</label>
                                        <input id="editDias" type="number" min="1" style="width:100%; padding:10px; border:1px solid #D1D5DB; border-radius:8px;" />
                                    </div>
                                    <div>
                                        <label style="display:block; margin-bottom:6px; font-weight:700;">Max dispositivos</label>
                                        <input id="editMax" type="number" min="1" style="width:100%; padding:10px; border:1px solid #D1D5DB; border-radius:8px;" />
                                    </div>
                                </div>
                                <div>
                                    <label style="display:block; margin-bottom:6px; font-weight:700;">Estado</label>
                                    <select id="editEstado" style="width:100%; padding:10px; border:1px solid #D1D5DB; border-radius:8px;">
                                        <option value="PENDIENTE">PENDIENTE</option>
                                        <option value="ACTIVA">ACTIVA</option>
                                        <option value="VENCIDA">VENCIDA</option>
                                        <option value="BLOQUEADA">BLOQUEADA</option>
                                    </select>
                                    <div style="margin-top:6px; color:#6B7280; font-size:0.85rem;">
                                        Nota: si pones <b>ACTIVA</b> y no estaba iniciada, se iniciar√° y se calcular√° fecha fin.
                                    </div>
                                </div>
                                <div>
                                    <label style="display:block; margin-bottom:6px; font-weight:700;">Notas</label>
                                    <textarea id="editNotas" rows="3" style="width:100%; padding:10px; border:1px solid #D1D5DB; border-radius:8px;"></textarea>
                                </div>

                                <div style="display:flex; gap:10px; justify-content:flex-end;">
                                    <button onclick="closeEditModal()" style="padding:10px 14px; border-radius:8px; border:1px solid #D1D5DB; background:#fff; cursor:pointer; font-weight:800;">Cancelar</button>
                                    <button id="editSaveBtn" onclick="saveEdit()" style="padding:10px 14px; border-radius:8px; border:none; background:#10B981; color:#fff; cursor:pointer; font-weight:900;">Guardar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalsHtml);
        }

        let currentEditLicenseId = null;

        async function openDetailModal(licenseId) {
            ensureModals();

            try {
                const response = await fetch(`${API_URL}/api/admin/licenses/${licenseId}`, {
                    method: 'GET',
                    headers: { 'x-session-id': sessionId }
                });
                const data = await response.json();
                if (!data.ok) {
                    showMessage('‚ùå ' + (data.message || 'No se pudo cargar la licencia'), 'error');
                    return;
                }

                const l = data.license;
                document.getElementById('detailSub').textContent = `${l.nombre_negocio || '‚Äî'} ‚Ä¢ ${l.tipo} ‚Ä¢ ${l.estado}`;

                const fechaInicio = l.fecha_inicio ? new Date(l.fecha_inicio).toLocaleString('es-ES') : 'N/A';
                const fechaFin = l.fecha_fin ? new Date(l.fecha_fin).toLocaleString('es-ES') : 'N/A';

                const detailBody = document.getElementById('detailBody');
                detailBody.innerHTML = `
                    <div><div style="color:#6B7280; font-size:0.85rem;">License Key</div><div style="font-family:monospace; font-weight:900; word-break:break-all;">${l.license_key}</div></div>
                    <div><div style="color:#6B7280; font-size:0.85rem;">Cliente</div><div style="font-weight:800;">${l.nombre_negocio || '‚Äî'}</div></div>
                    <div><div style="color:#6B7280; font-size:0.85rem;">D√≠as validez</div><div style="font-weight:800;">${l.dias_validez}</div></div>
                    <div><div style="color:#6B7280; font-size:0.85rem;">Max dispositivos</div><div style="font-weight:800;">${l.max_dispositivos}</div></div>
                    <div><div style="color:#6B7280; font-size:0.85rem;">Fecha inicio</div><div style="font-weight:800;">${fechaInicio}</div></div>
                    <div><div style="color:#6B7280; font-size:0.85rem;">Fecha fin</div><div style="font-weight:800;">${fechaFin}</div></div>
                    <div style="grid-column:1 / -1;"><div style="color:#6B7280; font-size:0.85rem;">Notas</div><div style="font-weight:700;">${l.notas ? l.notas : '‚Äî'}</div></div>

                    <div style="grid-column:1 / -1; display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
                        <button onclick="promptOfflineDownload('${licenseId}')" style="padding:10px 14px; border-radius:8px; border:none; background:#111827; color:#fff; cursor:pointer; font-weight:900;">üíæ Descargar licencia offline</button>
                        <button onclick="activarManual('${licenseId}')" style="padding:10px 14px; border-radius:8px; border:none; background:#F59E0B; color:#fff; cursor:pointer; font-weight:900;">Iniciar/Activar</button>
                    </div>
                    <div style="grid-column:1 / -1; color:#6B7280; font-size:0.85rem; margin-top:-4px;">
                        Offline genera un archivo firmado. Si sale ‚Äúno configurada‚Äù, configura <b>LICENSE_SIGN_PRIVATE_KEY</b> y <b>LICENSE_SIGN_PUBLIC_KEY</b> en el backend.
                    </div>
                `;

                const activations = Array.isArray(l.activations) ? l.activations : [];
                const box = document.getElementById('activationsBox');
                if (!activations.length) {
                    box.innerHTML = `<div style="padding:16px; color:#6B7280;">No hay activaciones registradas.</div>`;
                } else {
                    let ahtml = `<table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#F3F4F6; border-bottom:1px solid #E5E7EB;">
                                <th style="padding:10px; text-align:left;">Device ID</th>
                                <th style="padding:10px; text-align:left;">Estado</th>
                                <th style="padding:10px; text-align:left;">Activada</th>
                                <th style="padding:10px; text-align:left;">√öltimo check</th>
                                <th style="padding:10px; text-align:left;">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    activations.forEach(a => {
                        const estado = a.estado || '‚Äî';
                        const activatedAt = a.activated_at ? new Date(a.activated_at).toLocaleString('es-ES') : '‚Äî';
                        const lastCheck = a.last_check_at ? new Date(a.last_check_at).toLocaleString('es-ES') : '‚Äî';
                        const canRevoke = estado === 'ACTIVA';
                        ahtml += `
                            <tr style="border-bottom:1px solid #E5E7EB;">
                                <td style="padding:10px; font-family:monospace;">${a.device_id}</td>
                                <td style="padding:10px; font-weight:800;">${estado}</td>
                                <td style="padding:10px;">${activatedAt}</td>
                                <td style="padding:10px;">${lastCheck}</td>
                                <td style="padding:10px;">
                                    ${canRevoke
                                        ? `<button onclick="revokeActivation('${a.id}', '${licenseId}')" style="padding:6px 10px; border:none; border-radius:6px; background:#EF4444; color:#fff; cursor:pointer; font-weight:900; font-size:12px;">Revocar</button>`
                                        : `<span style="color:#6B7280; font-size:0.85rem;">‚Äî</span>`
                                    }
                                </td>
                            </tr>
                        `;
                    });

                    ahtml += `</tbody></table>`;
                    box.innerHTML = ahtml;
                }

                document.getElementById('licenseDetailModal').style.display = 'flex';
            } catch (e) {
                showMessage('‚ùå Error: ' + e.message, 'error');
            }
        }

        function closeDetailModal() {
            const modal = document.getElementById('licenseDetailModal');
            if (modal) modal.style.display = 'none';
        }

        async function revokeActivation(activationId, licenseId) {
            if (!confirm('¬øRevocar esta activaci√≥n? El dispositivo quedar√° invalidado.')) return;
            try {
                const response = await fetch(`${API_URL}/api/admin/activations/${activationId}/revocar`, {
                    method: 'PATCH',
                    headers: { 'x-session-id': sessionId }
                });
                const data = await response.json();
                if (data.ok) {
                    showMessage('‚úÖ Activaci√≥n revocada', 'success');
                    // refrescar modal
                    await openDetailModal(licenseId);
                    // refrescar tabla
                    await loadLicenses();
                } else {
                    showMessage('‚ùå ' + (data.message || 'No se pudo revocar'), 'error');
                }
            } catch (e) {
                showMessage('‚ùå Error: ' + e.message, 'error');
            }
        }

        async function openEditModal(licenseId) {
            ensureModals();
            currentEditLicenseId = licenseId;

            try {
                const response = await fetch(`${API_URL}/api/admin/licenses/${licenseId}`, {
                    method: 'GET',
                    headers: { 'x-session-id': sessionId }
                });
                const data = await response.json();
                if (!data.ok) {
                    showMessage('‚ùå ' + (data.message || 'No se pudo cargar la licencia'), 'error');
                    return;
                }

                const l = data.license;
                document.getElementById('editTipo').value = l.tipo;
                document.getElementById('editDias').value = l.dias_validez;
                document.getElementById('editMax').value = l.max_dispositivos;
                document.getElementById('editEstado').value = l.estado;
                document.getElementById('editNotas').value = l.notas || '';

                document.getElementById('licenseEditModal').style.display = 'flex';
            } catch (e) {
                showMessage('‚ùå Error: ' + e.message, 'error');
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('licenseEditModal');
            if (modal) modal.style.display = 'none';
            currentEditLicenseId = null;
        }

        async function saveEdit() {
            const btn = document.getElementById('editSaveBtn');
            if (!currentEditLicenseId) return;

            const tipo = document.getElementById('editTipo').value;
            const dias = Number(document.getElementById('editDias').value);
            const maxDisp = Number(document.getElementById('editMax').value);
            const estado = document.getElementById('editEstado').value;
            const notas = document.getElementById('editNotas').value;

            if (!tipo || !estado || !Number.isFinite(dias) || dias <= 0 || !Number.isFinite(maxDisp) || maxDisp <= 0) {
                showMessage('‚ùå Revisa los campos (n√∫meros > 0)', 'error');
                return;
            }

            btn.disabled = true;
            const oldText = btn.textContent;
            btn.textContent = 'Guardando...';

            try {
                const response = await fetch(`${API_URL}/api/admin/licenses/${currentEditLicenseId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-session-id': sessionId
                    },
                    body: JSON.stringify({
                        tipo,
                        dias_validez: Math.floor(dias),
                        max_dispositivos: Math.floor(maxDisp),
                        estado,
                        notas: notas || null
                    })
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage('‚úÖ Licencia actualizada', 'success');
                    closeEditModal();
                    await loadLicenses();
                } else {
                    showMessage('‚ùå ' + (data.message || 'No se pudo actualizar'), 'error');
                }
            } catch (e) {
                showMessage('‚ùå Error: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = oldText;
            }
        }

        async function bloquearLicense(licenseId) {
            if (!confirm('¬øBloquear esta licencia?')) return;
            try {
                const response = await fetch(`${API_URL}/api/admin/licenses/${licenseId}/bloquear`, {
                    method: 'PATCH',
                    headers: { 'x-session-id': sessionId }
                });
                const data = await response.json();
                if (data.ok) {
                    showMessage('‚úÖ Licencia bloqueada', 'success');
                    await loadLicenses();
                } else {
                    showMessage('‚ùå ' + (data.message || 'No se pudo bloquear'), 'error');
                }
            } catch (e) {
                showMessage('‚ùå Error: ' + e.message, 'error');
            }
        }

        async function deleteLicense(licenseId) {
            if (!confirm('¬øEliminar esta licencia?\n\nEsto borrar√° tambi√©n sus activaciones asociadas.')) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/licenses/${licenseId}`, {
                    method: 'DELETE',
                    headers: { 'x-session-id': sessionId }
                });
                const data = await response.json();
                if (response.ok && data.ok) {
                    showMessage('‚úÖ Licencia eliminada', 'success');
                    loadLicenses();
                } else {
                    showMessage('‚ùå ' + (data.message || 'No se pudo eliminar'), 'error');
                }
            } catch (e) {
                showMessage('‚ùå Error al eliminar: ' + (e.message || e), 'error');
            }
        }

        async function activarManual(licenseId) {
            if (!confirm('¬øActivar/Desbloquear manualmente esta licencia?')) return;
            try {
                const response = await fetch(`${API_URL}/api/admin/licenses/${licenseId}/activar-manual`, {
                    method: 'PATCH',
                    headers: { 'x-session-id': sessionId }
                });
                const data = await response.json();
                if (data.ok) {
                    showMessage('‚úÖ Licencia activada/desbloqueada', 'success');
                    await loadLicenses();
                } else {
                    showMessage('‚ùå ' + (data.message || 'No se pudo activar'), 'error');
                }
            } catch (e) {
                showMessage('‚ùå Error: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>
